---
title: "Untitled"
author: "Kate Tran"
date: "6/6/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Library
```{r}
library(dplyr)
library(readr)
library(ggplot2)
# library(tidyr)
library(ggpubr)
library(gridExtra)
library(grid)
# library(RVAideMemoire)
# library(scales)                                                                                                                               
library(sjmisc)
library(ggeffects)
```

# Create data
```{r}
data_wide <- read_csv("../data/dataset_SGM_wide_2tp.csv")
data_wide <- data_wide %>% 
  mutate(reshist_state_so_factor = reshist_state_so_factor)
```

# Figure 1 # Two way interaction
```{r}
# BPM # state
bpm_state_fit <- lm(bpm_y_scr_totalprob_t_mean ~ sex_orient_bin_inclusive_ever*reshist_state_so_factor, data = data_wide)
bpm_state_df <- ggpredict(bpm_state_fit, terms = c("reshist_state_so_factor", "sex_orient_bin_inclusive_ever"))
plot1 <- ggplot(bpm_state_df, aes(x, predicted, colour = group)) + 
  geom_line()

# SI # state
SI_state_fit <- glm(SI_y_ever ~ sex_orient_bin_inclusive_ever*reshist_state_so_factor, data = data_wide, family = "binomial")
SI_state_df <- ggpredict(SI_state_fit, terms = c("reshist_state_so_factor", "sex_orient_bin_inclusive_ever"))
plot2 <- ggplot(SI_state_df, aes(x, predicted, colour = group)) + 
  geom_line()

# SA # state
SA_state_fit <- glm(SA_y_ever ~ sex_orient_bin_inclusive_ever*reshist_state_so_factor, data = data_wide, family = "binomial")
SA_state_df <- ggpredict(SA_state_fit, terms = c("reshist_state_so_factor", "sex_orient_bin_inclusive_ever"))
plot3 <- ggplot(SA_state_df, aes(x, predicted, colour = group)) + 
  geom_line()


# BPM # individual
bpm_indi_fit <- lm(bpm_y_scr_totalprob_t_mean ~ dim_yesno_q3_ever*reshist_state_so_factor, data = data_wide)
bpm_indi_df <- ggpredict(bpm_indi_fit, terms = c("reshist_state_so_factor", "dim_yesno_q3_ever"))
plot4 <- ggplot(bpm_indi_df, aes(x, predicted, colour = group)) + 
  geom_line()

# SI # individual
SI_indi_fit <- glm(SI_y_ever ~ dim_yesno_q3_ever*reshist_state_so_factor, data = data_wide, family = "binomial")
SI_indi_df <- ggpredict(SI_indi_fit, terms = c("reshist_state_so_factor", "dim_yesno_q3_ever"))
plot5 <- ggplot(SI_indi_df, aes(x, predicted, colour = group)) + 
  geom_line()

# SA # individual
SA_indi_fit <- glm(SA_y_ever ~ dim_yesno_q3_ever*reshist_state_so_factor, data = data_wide, family = "binomial")
SA_indi_df <- ggpredict(SA_indi_fit, terms = c("reshist_state_so_factor", "dim_yesno_q3_ever"))
plot6 <- ggplot(SA_indi_df, aes(x, predicted, colour = group)) + 
  geom_line()
```

```{r}
ggarrange(
  ggarrange(
  plot1 +
    theme(plot.margin = margin(r = 1, l = 1)),
  NULL,
  plot2 + 
    theme(plot.margin = margin(r = 1, l = 1)), 
  NULL,
  plot3 + 
    theme(plot.margin = margin(l = 1),
    ), 
  nrow = 1,
  widths = c(1, 0.05, 1, 0.05, 1),
  heights = c(5,5,5,5,5),
  common.legend = T,
  legend = "right"),
  
  ggarrange(
  plot4 +
    theme(plot.margin = margin(r = 1, l = 1)),
  NULL,
  plot5 + 
    theme(plot.margin = margin(r = 1, l = 1)), 
  NULL,
  plot6 + 
    theme(plot.margin = margin(l = 1),
    ), 
  nrow = 1,
  widths = c(1, 0.05, 1, 0.05, 1),
  heights = c(5,5,5,5,5),
  common.legend = T,
  legend = "right"),
  
  nrow = 2
)
```

# Three-way interaction
```{r}
fit <- glm(SA_y_ever ~ dim_yesno_q3_ever*reshist_state_so_factor*sex_orient_bin_inclusive_ever, data = data_wide, family = "binomial")
mydf <- ggpredict(fit, terms = c("reshist_state_so_factor", "dim_yesno_q3_ever", "sex_orient_bin_inclusive_ever"))
ggplot(mydf, aes(x, predicted, colour = group)) + 
  geom_line() +
  facet_wrap(~facet) # this is for 3-way interaction
```


# Merge plots

```{r}
ggarrange(
  ggarrange(
  plot_1 +
    theme(plot.margin = margin(r = 1, l = 1)),
  NULL,
  plot_3 + 
    theme(plot.margin = margin(r = 1, l = 1)), 
  NULL,
  plot_5 + 
    theme(plot.margin = margin(l = 1),
    ), 
  nrow = 1,
  widths = c(1, 0.05, 1, 0.05, 1),
  heights = c(5,5,5,5,5),
  common.legend = T,
  legend = "right"),
  
  ggarrange(
  plot_2 +
    theme(plot.margin = margin(r = 1, l = 1)),
  NULL,
  plot_4 + 
    theme(plot.margin = margin(r = 1, l = 1)), 
  NULL,
  plot_6 + 
    theme(plot.margin = margin(l = 1),
    ), 
  nrow = 1,
  widths = c(1, 0.05, 1, 0.05, 1),
  heights = c(5,5,5,5,5),
  common.legend = T,
  legend = "right"),
  
  nrow = 2
)

ggsave("../plots/interaction_plots_main_101722.png", width = 6.5, height = 5, dpi = 620)
```

